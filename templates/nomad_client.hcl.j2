data_dir = "{{ nomad_data_dir }}"

server {
  enabled = false
}

client {
  enabled   = true
  servers   = ["{{ hostvars[groups['nomad_server'][0]].ansible_host }}:4647"]
  alloc_dir = "{{ nomad_alloc_dir }}"
  
  # Reserved resources configuration
  reserved {
    cpu = {{ nomad_reserved_cpu | default(500) }}
    memory = {{ nomad_reserved_memory | default(512) }}
    disk = {{ nomad_reserved_disk | default(1024) }}
  }
}

bind_addr = "0.0.0.0"
log_level = "INFO"

advertise {
  http = "{{ ansible_host }}"
  rpc  = "{{ ansible_host }}"
  serf = "{{ ansible_host }}"
}

consul {
  address = "{{ consul_address }}"
}

{% if has_nvidia_gpu | default(false) %}
plugin "nomad-device-nvidia" {
  config {
    enabled = true
    fingerprint_period = "1m"
    
    # NVIDIA specific configurations
    nvidia_runtime = "nvidia"
    allowed_capabilities = ["compute", "utility"]
  }
}
{% else %}
# No NVIDIA GPU detected on this node
# GPU jobs will not be scheduled here
{% endif %}